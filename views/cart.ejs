<!doctype html>
<html>

<head>
  <%- include("partials/head") %>
</head>

<body class="page-enter bg-bg-main text-text-main flex flex-col min-h-screen">
  <%- include("partials/nav", { user }) %>

  <main class="flex-grow max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">
    <div class="flex items-center justify-between mb-6">
      <h1 class="headline text-2xl text-text-main">Carrinho</h1>
      <a href="/" class="text-sm text-text-meta hover:text-primary">Continuar comprando</a>
    </div>

    <div class="glass rounded-2xl border border-white/10 shadow-soft p-6">
      <div id="cart-empty" class="text-text-meta">Seu carrinho est√° vazio.</div>
      <div id="cart-list" class="hidden space-y-4"></div>
      <div id="cart-summary" class="hidden mt-6 border-t border-white/10 pt-4 flex items-center justify-between">
        <div class="text-text-meta">Total</div>
        <div id="cart-total" class="text-primary font-semibold"></div>
      </div>
      <div id="cart-actions" class="hidden mt-6 flex flex-col sm:flex-row gap-3">
        <button class="px-6 py-3 rounded-xl bg-primary text-black font-semibold shadow-glow hover:bg-green-600 transition-colors">Ir para pagamento</button>
        <button id="cart-clear" class="px-6 py-3 rounded-xl bg-bg-card border border-white/10 text-text-main hover:bg-bg-surface transition-colors">Limpar carrinho</button>
      </div>
    </div>
  </main>

  <script>
    (function () {
      const list = document.getElementById('cart-list');
      const empty = document.getElementById('cart-empty');
      const summary = document.getElementById('cart-summary');
      const totalEl = document.getElementById('cart-total');
      const actions = document.getElementById('cart-actions');
      const clearBtn = document.getElementById('cart-clear');

      function getCart() {
        try {
          return JSON.parse(localStorage.getItem('sqm_cart') || '[]');
        } catch {
          return [];
        }
      }

      function formatBRL(value) {
        return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
      }

      function render() {
        const cart = getCart();
        list.innerHTML = '';
        if (!cart.length) {
          empty.classList.remove('hidden');
          list.classList.add('hidden');
          summary.classList.add('hidden');
          actions.classList.add('hidden');
          return;
        }

        empty.classList.add('hidden');
        list.classList.remove('hidden');
        summary.classList.remove('hidden');
        actions.classList.remove('hidden');

        let total = 0;
        cart.forEach(item => {
          total += item.price_cents * item.qty;
          const row = document.createElement('div');
          row.className = 'flex items-center justify-between bg-bg-card border border-white/10 rounded-xl p-4';
          row.innerHTML = `
            <div class="flex items-center gap-3">
              <img src="${item.image_url}" class="w-12 h-12 rounded-lg object-cover" />
              <div>
                <div class="headline text-text-main">${item.name}</div>
                <div class="text-xs text-text-meta">Qtd: ${item.qty}</div>
              </div>
            </div>
            <div class="text-primary font-semibold">${formatBRL((item.price_cents*item.qty)/100)}</div>
          `;
          list.appendChild(row);
        });
        totalEl.textContent = formatBRL(total / 100);
      }

      clearBtn.addEventListener('click', () => {
        localStorage.removeItem('sqm_cart');
        render();
      });

      render();
    })();
  </script>
</body>

</html>
