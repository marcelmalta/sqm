<!doctype html>
<html>

<head>
  <%- include("partials/head") %>
</head>

<body class="page-enter bg-bg-main text-text-main flex flex-col min-h-screen">
  <%- include("partials/nav", { user }) %>

  <main class="flex-grow max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">
    <section class="relative overflow-hidden glass rounded-2xl border border-white/10 shadow-soft p-6 md:p-10">
      <div class="absolute -top-24 -right-24 w-72 h-72 bg-primary/10 rounded-full blur-3xl"></div>
      <div class="absolute -bottom-24 -left-24 w-72 h-72 bg-white/5 rounded-full blur-3xl"></div>
      <div class="relative flex flex-col md:flex-row items-start md:items-center gap-8">
        <div class="flex-1">
          <div class="inline-flex items-center gap-3 bg-bg-card border border-white/10 rounded-full px-3 py-1 text-xs text-text-meta">
            <span class="w-2 h-2 rounded-full bg-primary"></span>
            Jornal SQM Brasil · Comunidade em forma de conteúdo
          </div>
          <h1 class="headline text-3xl md:text-5xl mt-4 text-text-main">Informação, relatos e trocas do nicho em um só feed</h1>
          <p class="text-text-meta mt-3 max-w-2xl">
            Um jornal vivo da comunidade SQM, com postagens organizadas em cards para leitura e interação rápida.
          </p>
          <div class="mt-6 flex flex-col sm:flex-row gap-3">
            <a href="#feed" class="inline-flex items-center justify-center px-6 py-3 rounded-xl bg-primary text-black font-semibold shadow-glow hover:bg-green-600 transition-colors">Ver postagens</a>
            <a href="/shop" class="inline-flex items-center justify-center px-6 py-3 rounded-xl bg-bg-card border border-white/10 text-text-main font-semibold hover:bg-bg-surface transition-colors">Ir para shop</a>
          </div>
        </div>
        <div class="flex-shrink-0">
          <div class="w-36 h-36 rounded-3xl bg-gradient-to-br from-primary/30 via-white/5 to-white/0 border border-white/10 shadow-soft flex items-center justify-center">
            <img src="/images/logo-badge.jpeg" alt="SQM Brasil" class="w-20 h-20" />
          </div>
        </div>
      </div>
    </section>

    <section class="mt-8" id="feed">
      <form action="/" method="GET" class="relative">
        <input type="text" name="q" placeholder="Buscar posts, relatos, tratamentos..." value="<%= q %>"
          class="w-full h-12 pl-12 pr-4 rounded-xl border border-white/10 bg-bg-card text-text-main placeholder-text-meta focus:ring-2 focus:ring-primary focus:outline-none">
        <div class="absolute left-4 top-3.5 text-text-meta">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </div>
        <% if (cat) { %><input type="hidden" name="cat" value="<%= cat %>"><% } %>
      </form>

      <div class="flex gap-2 overflow-x-auto pb-2 mt-4">
        <a href="/?q=<%= q %>"
          class="whitespace-nowrap px-4 py-2 rounded-full text-xs font-semibold uppercase tracking-wide transition-colors <%= !cat ? 'bg-primary text-black shadow-glow' : 'bg-bg-card text-text-meta border border-white/10' %>">Todas</a>
        <% categories.forEach(c=> { %>
          <a href="/?cat=<%= c.category %>&q=<%= q %>"
            class="whitespace-nowrap px-4 py-2 rounded-full text-xs font-semibold uppercase tracking-wide transition-colors <%= cat === c.category ? 'bg-primary text-black shadow-glow' : 'bg-bg-card text-text-meta border border-white/10' %>"><%= c.category %></a>
        <% }) %>
      </div>
    </section>

    <section class="mt-8">
      <div class="flex items-center justify-between mb-6">
        <h2 class="headline text-2xl text-text-main"><% if(q) { %>Resultados para "<%= q %>"<% } else if(cat) { %>Categoria: <%= cat %><% } else { %>Últimos posts<% } %></h2>
      </div>

      <% if (!posts.length) { %>
        <div class="glass rounded-2xl border border-white/10 text-center p-6">
          <p class="text-text-meta">Nenhum post encontrado.</p>
        </div>
      <% } %>

      <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5">
        <% posts.forEach(p=> { %>
          <button type="button"
            class="group text-left glass rounded-2xl border border-white/10 p-5 hover:shadow-glow transition-all duration-300 hover:-translate-y-1"
            data-post-slug="<%= p.slug %>">
            <div class="flex items-center justify-between mb-4">
              <span class="px-2.5 py-1 rounded-full text-xs font-semibold bg-primary/15 text-primary uppercase tracking-wide"><%= p.category %></span>
              <span class="text-xs text-text-meta"><%= new Date(p.created_at).toLocaleDateString('pt-BR') %></span>
            </div>
            <h3 class="headline text-lg text-text-main group-hover:text-primary line-clamp-2"><%= p.title %></h3>
            <p class="text-text-meta text-sm line-clamp-3 mt-3"><%= p.excerpt %></p>
            <div class="flex items-center gap-2 pt-4 mt-4 border-t border-white/10">
              <div class="w-7 h-7 rounded-full bg-primary/15 text-primary flex items-center justify-center text-xs font-bold">
                <%= p.author_display ? p.author_display[0].toUpperCase() : '?' %>
              </div>
              <span class="text-xs text-text-meta font-medium truncate"><%= p.author_display %></span>
            </div>
          </button>
        <% }) %>
      </div>
    </section>

    <!-- Modal Post -->
    <div id="post-modal" class="fixed inset-0 hidden items-center justify-center bg-black/70 backdrop-blur-sm z-50">
      <div class="glass rounded-2xl border border-white/10 shadow-soft p-6 w-full max-w-3xl mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex items-start justify-between gap-4">
          <div>
            <div class="text-xs text-text-meta mb-2" id="modal-meta"></div>
            <h3 id="modal-title" class="headline text-2xl text-text-main"></h3>
            <p id="modal-author" class="text-text-meta mt-2"></p>
          </div>
          <button id="post-modal-close" class="text-text-meta hover:text-text-main">✕</button>
        </div>
        <div class="mt-5">
          <p id="modal-content" class="text-text-main leading-relaxed whitespace-pre-wrap"></p>
        </div>

        <div class="mt-6 flex flex-wrap gap-3">
          <button id="like-btn" class="px-4 py-2 rounded-lg bg-bg-card border border-white/10 text-text-main hover:bg-bg-surface transition-colors">
            👍 Curtir <span id="like-count" class="text-text-meta ml-1">0</span>
          </button>
          <button id="share-btn" class="px-4 py-2 rounded-lg bg-bg-card border border-white/10 text-text-main hover:bg-bg-surface transition-colors">Compartilhar</button>
          <a id="full-link" href="#" class="px-4 py-2 rounded-lg bg-primary text-black font-semibold hover:bg-green-600 transition-colors">Abrir post</a>
        </div>

        <div class="mt-6 border-t border-white/10 pt-6">
          <h4 class="headline text-lg text-text-main mb-3">Comente</h4>
          <form id="modal-comment-form" method="post" action="#" class="space-y-3">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <input type="hidden" name="form_ts" id="modal-form-ts" value="">
            <input type="text" name="website" class="hidden" tabindex="-1" autocomplete="off">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <input type="text" name="author_name" required minlength="2" maxlength="60"
                class="w-full bg-bg-card border-white/10 rounded-lg p-3 focus:ring-2 focus:ring-primary focus:bg-bg-surface transition-all text-base"
                placeholder="Seu nome">
              <input type="email" name="author_email" maxlength="120"
                class="w-full bg-bg-card border-white/10 rounded-lg p-3 focus:ring-2 focus:ring-primary focus:bg-bg-surface transition-all text-base"
                placeholder="Seu email (opcional)">
            </div>
            <textarea name="body" rows="4"
              class="w-full bg-bg-card border-white/10 rounded-lg p-3 focus:ring-2 focus:ring-primary focus:bg-bg-surface transition-all text-base"
              placeholder="Escreva sua opinião..." required></textarea>
            <div class="flex justify-end">
              <button class="bg-primary text-black px-6 py-2 rounded-lg font-semibold hover:bg-green-600 transition-colors shadow-glow">Enviar comentário</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </main>

  <script>
    window.__POSTS__ = <%- JSON.stringify(posts.map(p => ({
      slug: p.slug,
      title: p.title,
      excerpt: p.excerpt,
      content: p.content,
      category: p.category,
      author: p.author_display,
      created_at: p.created_at
    }))) %>;

    (function () {
      const modal = document.getElementById('post-modal');
      const closeBtn = document.getElementById('post-modal-close');
      const title = document.getElementById('modal-title');
      const content = document.getElementById('modal-content');
      const meta = document.getElementById('modal-meta');
      const author = document.getElementById('modal-author');
      const fullLink = document.getElementById('full-link');
      const likeBtn = document.getElementById('like-btn');
      const likeCount = document.getElementById('like-count');
      const shareBtn = document.getElementById('share-btn');
      const form = document.getElementById('modal-comment-form');
      const formTs = document.getElementById('modal-form-ts');

      function getLikes(slug) {
        try {
          return Number(localStorage.getItem('like_' + slug) || '0');
        } catch {
          return 0;
        }
      }

      function setLikes(slug, value) {
        try {
          localStorage.setItem('like_' + slug, String(value));
        } catch {}
      }

      function openModal(data) {
        if (!data) return;
        title.textContent = data.title;
        content.textContent = data.content || data.excerpt;
        meta.textContent = data.category + ' · ' + new Date(data.created_at).toLocaleDateString('pt-BR');
        author.textContent = 'Por ' + (data.author || 'Anônimo');
        fullLink.href = '/p/' + data.slug;
        form.action = '/p/' + data.slug + '/comment';
        formTs.value = Date.now();

        const likes = getLikes(data.slug);
        likeCount.textContent = likes;
        likeBtn.onclick = () => {
          const next = getLikes(data.slug) + 1;
          setLikes(data.slug, next);
          likeCount.textContent = next;
        };

        shareBtn.onclick = async () => {
          const url = window.location.origin + '/p/' + data.slug;
          try {
            await navigator.clipboard.writeText(url);
            shareBtn.textContent = 'Link copiado';
            setTimeout(() => (shareBtn.textContent = 'Compartilhar'), 1500);
          } catch {
            window.open(url, '_blank');
          }
        };

        modal.classList.remove('hidden');
        modal.classList.add('flex');
      }

      function closeModal() {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }

      const posts = (window.__POSTS__ || []).reduce((acc, p) => {
        acc[p.slug] = p;
        return acc;
      }, {});

      document.querySelectorAll('[data-post-slug]').forEach(btn => {
        btn.addEventListener('click', () => {
          const slug = btn.getAttribute('data-post-slug');
          const data = posts[slug];
          openModal(data);
        });
      });

      closeBtn.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });
    })();
  </script>
</body>

</html>
